name: CI
# Trigger the CI on pull requests and direct pushes to any branch
on:
  push:
  pull_request:
jobs:
  verify-terraform:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v1

    - name: terraform fmt
      run: terraform fmt -check
      working-directory: ./terraform


  run-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2

    - name: Run tests
      run: go test -v ./...


  build-verify-feeds:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        feed: [crates, goproxy, npm, nuget, packagist, pypi, rubygems]
    steps:
    - uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.15

    - name: Copy in feed Makefile template
      run: cp .feedMakefile ${{ matrix.feed }}/Makefile
      working-directory: ./feeds

    - name: Add .gitignore to each feed
      run: echo -en "bin*\nMakefile\n.gitignore" > ${{ matrix.feed }}/.gitignore
      working-directory: ./feeds

    - name: Build feeds
      run: make build FEED=${{ matrix.feed }}
      working-directory: ./feeds/${{ matrix.feed }}

    - name: Verify feeds
      run: make verify FEED=${{ matrix.feed }}
      working-directory: ./feeds/${{ matrix.feed }}
